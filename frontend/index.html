<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>語音轉文字翻譯器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        padding: 1.5rem;
        background: #f4f5f8;
        color: #1f2937;
      }
      h1 {
        margin-top: 0;
        font-size: 1.8rem;
        color: #111827;
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
        padding: 2rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }
      input,
      select,
      button {
        font-size: 1rem;
      }
      .row {
        margin-bottom: 1.5rem;
      }
      button {
        background-color: #2563eb;
        color: #fff;
        border: none;
        padding: 0.75rem 1.2rem;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
      }
      button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
      }
      .result-section {
        margin-top: 2rem;
      }
      .result-section h2 {
        font-size: 1.3rem;
        color: #1d4ed8;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
      }
      pre {
        background: #0f172a;
        color: #f8fafc;
        padding: 1rem;
        border-radius: 0.75rem;
        overflow-x: auto;
      }
      .conversation {
        margin-top: 1rem;
        background: #f1f5f9;
        border-radius: 0.75rem;
        padding: 1rem;
      }
      .conversation-item {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px dashed #cbd5f5;
      }
      .conversation-item:last-child {
        border-bottom: none;
      }
      .speaker {
        font-weight: 700;
        color: #2563eb;
      }
      .badge {
        display: inline-block;
        background: #2563eb;
        color: #fff;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
        margin-right: 0.5rem;
      }
      details {
        margin-top: 1rem;
        background: #fff7ed;
        border-left: 4px solid #f97316;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
      }
      details summary {
        cursor: pointer;
        font-weight: 600;
      }
      .status {
        margin-bottom: 1rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>語音轉文字翻譯器</h1>
      <p style="margin-top: 0; color: #475569;">
        上傳國語或台語音檔，系統將執行語音辨識、翻譯與摘要，並呈現對話紀錄。
      </p>

      <form id="upload-form">
        <div class="row">
          <label for="audio-file">選擇音檔（wav/mp3/m4a/flac/ogg）</label>
          <input id="audio-file" type="file" accept="audio/*" required />
        </div>
        <div class="row">
          <label>
            <input id="translate-toggle" type="checkbox" checked />
            啟用翻譯
          </label>
        </div>
        <div class="row">
          <label for="target-language">翻譯目標語言（NLLB 語言碼）</label>
          <select id="target-language">
            <option value="zho_Hant" selected>繁體中文 (zho_Hant)</option>
            <option value="eng_Latn">英文 (eng_Latn)</option>
            <option value="nan_Latn">台語羅馬拼音 (nan_Latn)</option>
            <option value="">跟隨後端設定</option>
          </select>
        </div>
        <button id="upload-button" type="submit">送出</button>
      </form>

      <div id="status" class="status"></div>

      <div id="result" class="result-section" hidden>
        <section>
          <h2>摘要</h2>
          <div id="summary"></div>
        </section>
        <section class="result-section">
          <h2>對話紀錄</h2>
          <div id="conversation" class="conversation"></div>
        </section>
        <details>
          <summary>查看完整 JSON 結果</summary>
          <pre id="raw-json"></pre>
        </details>
      </div>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const resultSection = document.getElementById("result");
      const rawJson = document.getElementById("raw-json");
      const status = document.getElementById("status");
      const summaryContainer = document.getElementById("summary");
      const conversationContainer = document.getElementById("conversation");
      const uploadButton = document.getElementById("upload-button");

      function renderSummary(summary) {
        summaryContainer.innerHTML = "";
        const points = summary.key_points || [];
        const keywords = summary.keywords || [];

        if (!points.length && !keywords.length) {
          summaryContainer.textContent = "沒有可用的摘要資訊。";
          return;
        }

        if (points.length) {
          const list = document.createElement("ol");
          points.forEach((point) => {
            const item = document.createElement("li");
            item.textContent = point;
            list.appendChild(item);
          });
          summaryContainer.appendChild(list);
        }

        if (keywords.length) {
          const keywordWrap = document.createElement("p");
          keywordWrap.innerHTML =
            '<span class="badge">關鍵字</span>' + keywords.join("、");
          summaryContainer.appendChild(keywordWrap);
        }
      }

      function renderConversation(conversation) {
        conversationContainer.innerHTML = "";
        if (!conversation.length) {
          conversationContainer.textContent = "無對話資料。";
          return;
        }

        conversation.forEach((turn) => {
          const item = document.createElement("div");
          item.className = "conversation-item";

          const speaker = document.createElement("div");
          speaker.className = "speaker";
          speaker.textContent = turn.speaker;

          const text = document.createElement("p");
          text.textContent = turn.text;

          item.appendChild(speaker);
          item.appendChild(text);

          if (turn.translated_text) {
            const translated = document.createElement("p");
            translated.style.color = "#059669";
            translated.textContent = `翻譯：${turn.translated_text}`;
            item.appendChild(translated);
          }

          conversationContainer.appendChild(item);
        });
      }

      async function handleSubmit(event) {
        event.preventDefault();
        const fileInput = document.getElementById("audio-file");
        const translateToggle = document.getElementById("translate-toggle");
        const targetLanguage = document.getElementById("target-language");

        if (!fileInput.files.length) {
          alert("請選擇音檔");
          return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);
        formData.append("translate", translateToggle.checked ? "true" : "false");
        if (targetLanguage.value) {
          formData.append("target_language", targetLanguage.value);
        }

        uploadButton.disabled = true;
        status.textContent = `上傳「${file.name}」中，請稍候...`;
        status.style.color = "#2563eb";

        try {
          const response = await fetch("/transcribe", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "後端傳回錯誤");
          }

          const data = await response.json();

          renderSummary(data.summary || {});
          renderConversation(data.conversation || []);
          rawJson.textContent = JSON.stringify(data, null, 2);
          resultSection.hidden = false;

          status.textContent = `完成！偵測語言：${data.language}`;
          status.style.color = "#16a34a";
        } catch (err) {
          console.error(err);
          status.textContent = `錯誤：${err.message}`;
          status.style.color = "#dc2626";
          resultSection.hidden = true;
        } finally {
          uploadButton.disabled = false;
        }
      }

      form.addEventListener("submit", handleSubmit);
    </script>
  </body>
</html>
